description: >
  Runs the complete Maven lifecycle including tests and generates reports
  - Restores Maven dependency cache
  - Runs Maven verify (compile, test, package, verify)
  - Collects JaCoCo code coverage reports
  - Stores test output artifacts
  - Saves JUnit test results for CircleCI test reporting

steps:
  - checkout
  - run:
      name: Setup Maven Settings
      command: <<include(scripts/setup_maven_settings.sh)>>
  - run:
      name: Run Maven Verify
      command: <<include(scripts/mvn_verify_verify.sh)>>
  - run:
      name: Collect JaCoCo reports
      command: <<include(scripts/collect_jacoco_reports.sh)>>
      when: always
  - store_artifacts:
      path: /home/circleci/jacoco-reports
      destination: jacoco-reports
      when: always
  - run:
      name: Concatenate test output files
      command: <<include(scripts/concatenate_test_output.sh)>>
      when: always
  - store_artifacts:
      path: /home/circleci/test-output-artifacts
      destination: test-output
      when: always
  - run:
      name: Save test results
      command: <<include(scripts/mvn_verify_save_test_results.sh)>>
      when: always
  - store_test_results:
      path: ~/test-results
