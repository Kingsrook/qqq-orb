description: >
  Publishes artifacts to Maven Central (Sonatype Central Portal)
  - Restores Maven dependency cache
  - Debugs Maven settings to verify configuration
  - Sets up GPG signing for artifact verification
  - Deploys signed artifacts to Maven Central using release profile
  - Saves Maven cache for future builds

steps:
  - run:
      name: Setup GPG for signing
      command: |
        mkdir -p ~/.gnupg
        echo 'pinentry-mode loopback' > ~/.gnupg/gpg.conf
        chmod 600 ~/.gnupg/gpg.conf
        echo $GPG_PRIVATE_KEY_B64| tr -d ' \r\n\t' | base64 -d | gpg --batch --import
  - run:
      name: Publish to Sonatype Central (releases and SNAPSHOTs)
      command: |
        mvn -s .circleci/mvn-settings.xml -P release -B -DskipTests -Dgpg.keyname=$GPG_KEYNAME -Dgpg.passphrase=$GPG_PASSPHRASE deploy
  - save_cache:
      paths:
        - ~/.m2
      key: v1-dependencies-{{ checksum "pom.xml" }}
